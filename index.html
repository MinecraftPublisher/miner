<!DOCTYPE html>
<html>

<head>
    <title>Swapcoin</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport"
        content="target-densitydpi=device-dpi, width=device-width, user-scalable=no, maximum-scale=1, minimum-scale=1" />
    <link rel="apple-touch-icon" href="dollar.png">
    <link rel="shortcut-icon" href="dollar.png">
    <meta name="theme-color" content="#ffedd3" />
</head>

<body>
    <h1 onclick="navigator?.serviceWorker?.getRegistration().then(e => e?.unregister()); location.reload()">miner v2.2</h1>
    <h2>balance: 0 coins</h2>
    <h2 class="multiplier">multiplier: 0</h2>
    <h2 class="cap">storage capacity: 0</h2>
    <h2 class="tps">mining speed: 0 coins/s</h2>

    <content>
        <canvas></canvas>
        <br><br><br>
        <button onclick="mine()">mine</button><br>
        <button class="upgrade" onclick="_upgrade()">upgrade</button><br>
        <button class="tps" onclick="ticksupgrade()">upgrade tps</button>
    </content>

    <script>
        let x = JSON.parse(localStorage.getItem('balance') ?? '0')
        let tps = JSON.parse(localStorage.getItem('tps') ?? '2')
        let multiplier = JSON.parse(localStorage.getItem('multiplier') ?? '1')
        if (x < 0) x = 1000
        if (multiplier <= 0) multiplier = 1

        // window.onerror = (e) => alert(e)

        const h2 = document.querySelector('h2')
        const cap = document.querySelector('h2.cap')
        const tpsui = document.querySelector('h2.tps')
        const multi = document.querySelector('h2.multiplier')
        const upgrade = document.querySelector('button.upgrade')
        const ticks = document.querySelector('button.tps')
        const minor = document.querySelector('button')
        const canvas = document.querySelector('canvas')

        const calculate = ((mult) => {
            if(mult === tps) return Math.floor(mult ** 3 / 10)
            else return Math.floor(mult ** 2)
        })

        const getcap = (() => Math.floor((calculate(multiplier) * 20)))
        let __cap = getcap()

        let built = 10

        let first = 0
        let idle = 0

        let mined_leftover = 0
        let seconds_leftover = 0

        const mine_idle = ((original = true) => {
            let __last = JSON.parse(localStorage.getItem('last') ?? (+new Date).toString())
            let seconds = (+new Date - __last) / 1000
            
            if(seconds < 1) {
                seconds_leftover += seconds
                seconds = 0
            }

            if(seconds_leftover > 1) {
                seconds += Math.floor(seconds_leftover)
                seconds_leftover -= Math.floor(seconds_leftover)
            }

            let mined = (1 / tps) * (multiplier) * seconds

            if(mined < 1) {
                mined_leftover += mined
                mined = 0
            }

            if(mined_leftover > 1) {
                mined += Math.floor(mined_leftover)
                mined_leftover -= Math.floor(mined_leftover)
            }

            if(mined > __cap) mined = __cap

            x += mined

            if (first === 0) first = mined
            if(idle === 0) idle = seconds

            if(x > __cap) x = __cap

            if(original) save()

            __last = +new Date

            update_display()
        })

        function secondsToHms(d) {
            d = Number(d);

            var h = Math.floor(d / 3600)
            var m = Math.floor(d % 3600 / 60)
            var s = Math.floor(d % 3600 % 60)

            return ('0' + h).slice(-2) + ":" + ('0' + m).slice(-2) + ":" + ('0' + s).slice(-2)
        }

        const registerServiceWorker = async () => {
            if ("serviceWorker" in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register("sw.js", {
                        scope: "./",
                    })

                    if (registration.installing) {
                        // alert('installing offline...')
                        console.log("Service worker installing")
                    } else if (registration.waiting) {
                        // alert('waiting for activation...')
                        console.log("Service worker installed")
                    } else if (registration.active) {
                        // alert('now available for offline usage.')
                        console.log("Service worker active")
                    }
                } catch (error) {
                    // alert('offline version failed, reason: ' + error)
                    console.error(`Registration failed with ${error}`)
                }
            } else {
                // alert('incompatible registration.')
            }
        }

        registerServiceWorker()

        const ctx = canvas.getContext('2d')

        const vw = canvas.width
        const vh = canvas.height

        const whole = [0, 0, vw, vh]

        const update_display = (() => {
            x = Math.floor(x)
            multiplier = Math.floor(multiplier)

            const sandbox = ((mult) => {
                let count = 0
                let damn = x
                let istps = mult === tps
                const calculate2 = (() => {
                    if(istps) return Math.floor(mult ** 3 / 10)
                    else return Math.floor(mult ** 2)
                })

                while(damn > calculate2()) {
                    damn -= calculate2()
                    mult++
                    count++
                }

                return count
            })

            let updot = secondsToHms(Math.floor((((__cap - x) * (1 / tps) * (multiplier)))))
            cap.innerHTML = `storage capacity: ${__cap}<br>time to fill: ${updot}`
            multi.innerHTML = `multiplier: ${multiplier}`
            tpsui.innerHTML  = `mining speed: ${Math.round((1 / tps) * (multiplier) * 10) / 10} coins/s (${tps} tps)`
            upgrade.innerHTML = `upgrade (${calculate(multiplier)} coins, x${sandbox(multiplier)})`
            ticks.innerHTML = `upgrade tps (${calculate(tps)} coins, x${sandbox(tps)})`

            if (built-- > 1) {
                h2.innerHTML = `balance: ${x} coins<br>mined ${first} coins whilst idle for ${secondsToHms(idle)}`
            } else {
                h2.innerHTML = `balance: ${x} coins`
            }

            ctx.fillStyle = `gray`
            ctx.clearRect(...whole)
            ctx.fillRect(...whole)
            ctx.fillStyle = `rgb(183, 255, 183)`
            ctx.fillRect(0, 0, (vw * (x / __cap)), vh)
        })

        setInterval(() => {
            mine_idle()
        }, (1 / tps) * 1000)

        const save = (() => {
            mine_idle(false)

            localStorage.setItem('balance', Math.floor(x))
            localStorage.setItem('multiplier', Math.floor(multiplier))
            localStorage.setItem('tps', Math.floor(tps))
            localStorage.setItem('last', +new Date)
        })

        let g
        let f

        minor.addEventListener('touchstart', (e) => {
            g = setInterval(mine, 100)
            e.returnValue = false
        })

        minor.addEventListener('touchend', (e) => {
            mine()
            clearInterval(g)
            e.returnValue = false
        })

        save()

        function mine() {
            if(x >= __cap) return

            x += multiplier
            save()
        }

        function _upgrade() {
            while (x >= calculate(multiplier)) {
                x -= calculate(multiplier)
                multiplier += 1

                __cap = getcap()

                save()
            }
        }

        function ticksupgrade() {
            while (x >= calculate(tps)) {
                x -= calculate(tps)
                tps += 1

                save()
            }
        }
    </script>

    <style>
        body {
            font-size: 1.2rem;

            background-color: #ffedd3;

            font-family: serif !important;
        }

        content {
            position: fixed;
            bottom: 5rem;

            color: rgb(183, 255, 183);
        }

        h1 {
            text-align: center;
            margin-bottom: 0;
        }

        h2 {
            text-align: center;
            margin-bottom: 0;
            margin-top: 0;
            font-size: 1.5rem;
        }

        canvas {
            display: block;

            width: 80vw;
            height: 5vh;
            margin-left: 1.8rem;
        }

        button {
            user-select: none;

            border: none;
            outline: none;
            color: black;
            background-color: transparent;
            font-size: 2rem;
            margin: 0;
            padding: 0;

            margin-left: 2rem;

            font-family: serif !important;
        }
    </style>
</body>

</html>